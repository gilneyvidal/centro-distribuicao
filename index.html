<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CD - Centro de Distribui√ß√£o</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }

        /* TELA DE LOGIN */
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            margin: 0 auto;
        }

        .login-box h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* SISTEMA PRINCIPAL */
        .sistema {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .header h2 {
            color: #667eea;
        }

        .user-info {
            text-align: right;
        }

        .user-info span {
            display: block;
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .badge-admin {
            background: #dc3545;
            color: white;
        }

        .badge-operador {
            background: #28a745;
            color: white;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .card h3 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .menu-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px solid #28a745;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #28a745;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        .scan-status {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
            display: inline-block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- TELA DE LOGIN -->
        <div id="telaLogin" class="login-box">
            <h1>üè¢ Sistema CD</h1>
            <h3 style="text-align: center; color: #666; margin-bottom: 30px;">Centro de Distribui√ß√£o</h3>
            
            <div class="input-group">
                <label>Usu√°rio</label>
                <input type="text" id="loginUsuario" placeholder="Digite seu usu√°rio">
            </div>
            
            <div class="input-group">
                <label>Senha</label>
                <input type="password" id="loginSenha" placeholder="Digite sua senha">
            </div>
            
            <button class="btn" onclick="fazerLogin()">Entrar</button>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;"><strong>üë®‚Äçüíº Acesso Admin:</strong></p>
                <p style="font-size: 12px; color: #666;">Usu√°rio: <strong>admin</strong> | Senha: <strong>admin123</strong></p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;"><strong>üë∑ Acesso Operador:</strong></p>
                <p style="font-size: 12px; color: #666;">Usu√°rio: <strong>operador</strong> | Senha: <strong>oper123</strong></p>
            </div>
        </div>

        <!-- SISTEMA PRINCIPAL -->
        <div id="telaSistema" class="sistema hidden">
            <div class="header">
                <h2>üì¶ Sistema de Gest√£o CD</h2>
                <div class="user-info">
                    <span>Usu√°rio: <strong id="nomeUsuario"></strong></span>
                    <span class="badge" id="tipoUsuario"></span>
                    <button class="btn btn-secondary btn-small" onclick="fazerLogout()" style="margin-top: 10px;">Sair</button>
                </div>
            </div>

            <!-- DASHBOARD - APENAS PARA OPERADOR (SEM LUCRO) -->
            <div class="dashboard" id="dashboardOperador">
                <div class="card">
                    <h3 id="totalPacotes">0</h3>
                    <p>üì¶ Pacotes no Dep√≥sito</p>
                </div>
                <div class="card">
                    <h3 id="totalEntradas">0</h3>
                    <p>üì• Entradas Hoje</p>
                </div>
                <div class="card">
                    <h3 id="totalSaidas">0</h3>
                    <p>üì§ Sa√≠das Hoje</p>
                </div>
            </div>

            <!-- DASHBOARD - APENAS PARA ADMIN (COM LUCRO) -->
            <div class="dashboard hidden" id="dashboardAdmin">
                <div class="card">
                    <h3 id="totalPacotesAdmin">0</h3>
                    <p>üì¶ Pacotes no Dep√≥sito</p>
                </div>
                <div class="card">
                    <h3 id="totalLucro">R$ 0,00</h3>
                    <p>üí∞ Lucro Total</p>
                </div>
                <div class="card">
                    <h3 id="totalEntradasAdmin">0</h3>
                    <p>üì• Entradas Hoje</p>
                </div>
                <div class="card">
                    <h3 id="totalSaidasAdmin">0</h3>
                    <p>üì§ Sa√≠das Hoje</p>
                </div>
            </div>

            <!-- MENU DE ABAS -->
            <div class="menu-tabs">
                <button class="tab-btn active" onclick="abrirAba('entrada')">üì• Entrada de Pacotes</button>
                <button class="tab-btn" onclick="abrirAba('saida')">üì§ Sa√≠da de Pacotes</button>
                <button class="tab-btn" onclick="abrirAba('estoque')">üìã Estoque</button>
                <button class="tab-btn hidden" id="tabRelatorio" onclick="abrirAba('relatorio')">üìä Relat√≥rios</button>
                <button class="tab-btn hidden" id="tabConfig" onclick="abrirAba('config')">‚öôÔ∏è Configura√ß√µes</button>
            </div>

            <!-- ABA: ENTRADA DE PACOTES -->
            <div id="aba-entrada" class="tab-content active">
                <h3>üì• Registrar Entrada de Pacote</h3>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="abrirCamera('entrada')">üì∑ Escanear C√≥digo</button>
                    <div id="video-container" class="hidden">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                        <div class="scanner-overlay">
                            <div class="scanner-line"></div>
                        </div>
                        <div class="scan-status" id="scanStatus">üì∑ Posicione o c√≥digo na √°rea verde</div>
                        <button class="btn btn-danger" onclick="fecharCamera()" style="margin: 10px;">Fechar C√¢mera</button>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>C√≥digo do Pacote *</label>
                        <input type="text" id="codigoPacote" placeholder="Escaneie ou digite">
                    </div>
                    <div class="input-group">
                        <label>Fornecedor/Remetente *</label>
                        <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                    </div>
                    <div class="input-group">
                        <label>Cliente/Recebedor *</label>
                        <input type="text" id="cliente" placeholder="Nome do cliente">
                    </div>
                    <div class="input-group">
                        <label>Telefone do Cliente</label>
                        <input type="text" id="telefoneCliente" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="input-group">
                    <label>Observa√ß√µes</label>
                    <input type="text" id="observacoes" placeholder="Informa√ß√µes adicionais">
                </div>

                <div class="alert alert-success">
                    <strong>üìç Localiza√ß√£o Sugerida:</strong> <span id="localizacaoSugerida">-</span>
                </div>

                <button class="btn" onclick="registrarEntrada()">‚úÖ Registrar Entrada</button>
            </div>

            <!-- ABA: SA√çDA DE PACOTES -->
            <div id="aba-saida" class="tab-content">
                <h3>üì§ Registrar Sa√≠da de Pacote</h3>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="abrirCamera('saida')">üì∑ Escanear C√≥digo</button>
                </div>

                <div class="input-group">
                    <label>C√≥digo do Pacote *</label>
                    <input type="text" id="codigoPacoteSaida" placeholder="Escaneie ou digite">
                </div>

                <div id="infoPacote" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4>Informa√ß√µes do Pacote:</h4>
                    <p><strong>Cliente:</strong> <span id="infoCliente"></span></p>
                    <p><strong>Fornecedor:</strong> <span id="infoFornecedor"></span></p>
                    <p><strong>Localiza√ß√£o:</strong> <span id="infoLocalizacao"></span></p>
                    <p><strong>Data Entrada:</strong> <span id="infoDataEntrada"></span></p>
                </div>

                <button class="btn" onclick="buscarPacote()">üîç Buscar Pacote</button>
                <button class="btn btn-success hidden" id="btnConfirmarSaida" onclick="registrarSaida()">‚úÖ Confirmar Sa√≠da</button>
            </div>

            <!-- ABA: ESTOQUE -->
            <div id="aba-estoque" class="tab-content">
                <h3>üìã Estoque Atual</h3>
                
                <div class="input-group">
                    <input type="text" id="buscaEstoque" placeholder="üîç Buscar por c√≥digo, cliente ou fornecedor..." onkeyup="filtrarEstoque()">
                </div>

                <div id="loadingEstoque" class="loading hidden">Carregando estoque...</div>

                <table>
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Cliente</th>
                            <th>Fornecedor</th>
                            <th>Localiza√ß√£o</th>
                            <th>Data Entrada</th>
                            <th>Dias no CD</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaEstoque">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">Nenhum pacote no estoque</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ABA: RELAT√ìRIOS (APENAS ADMIN) -->
            <div id="aba-relatorio" class="tab-content">
                <h3>üìä Relat√≥rios e Hist√≥rico</h3>
                
                <div class="dashboard" style="margin-bottom: 30px;">
                    <div class="card">
                        <h3 id="relTotalProcessado">0</h3>
                        <p>Total de Pacotes Processados</p>
                    </div>
                    <div class="card">
                        <h3 id="relLucroTotal">R$ 0,00</h3>
                        <p>üí∞ Lucro Total Acumulado</p>
                    </div>
                </div>

                <h4>üìú Hist√≥rico de Movimenta√ß√µes</h4>
                <div id="loadingHistorico" class="loading hidden">Carregando hist√≥rico...</div>
                <table>
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>C√≥digo</th>
                            <th>Cliente</th>
                            <th>Fornecedor</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaHistorico">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">Nenhuma movimenta√ß√£o registrada</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ABA: CONFIGURA√á√ïES (APENAS ADMIN) -->
            <div id="aba-config" class="tab-content">
                <h3>‚öôÔ∏è Configura√ß√µes do Sistema</h3>
                
                <div class="alert alert-error">
                    <strong>‚ö†Ô∏è √Årea Administrativa</strong><br>
                    Apenas administradores podem acessar esta √°rea.
                </div>

                <h4>üó∫Ô∏è Configura√ß√£o de Prateleiras</h4>
                <p>Configure a estrutura do seu dep√≥sito:</p>
                
                <div class="form-grid">
                    <div class="input-group">
                        <label>Corredores (A-Z)</label>
                        <input type="number" id="numCorredores" value="5" min="1" max="26">
                    </div>
                    <div class="input-group">
                        <label>Prateleiras por Corredor</label>
                        <input type="number" id="numPrateleiras" value="10" min="1" max="99">
                    </div>
                    <div class="input-group">
                        <label>Andares por Prateleira</label>
                        <input type="number" id="numAndares" value="5" min="1" max="9">
                    </div>
                    <div class="input-group">
                        <label>Nichos por Andar</label>
                        <input type="number" id="numNichos" value="3" min="1" max="9">
                    </div>
                </div>

                <button class="btn" onclick="salvarConfiguracao()">üíæ Salvar Configura√ß√£o</button>

                <h4 style="margin-top: 30px;">üë• Gerenciar Usu√°rios</h4>
                <p style="color: #666; margin-bottom: 20px;">Em desenvolvimento - Pr√≥xima vers√£o</p>
            </div>
        </div>
    </div>

    <!-- BIBLIOTECAS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO SUPABASE
        // ==========================================
        const SUPABASE_URL = 'https://nneopnseeuhdtjqnqlcc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uZW9wbnNlZXVoZHRqcW5xbGNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDE4NzYsImV4cCI6MjA3ODAxNzg3Nn0.6nQq_A8rUfP-umbfy0w3GcZfCrSGGK62q0MMsSi6jUg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        console.log('‚úÖ Conectado ao Supabase');

        // ==========================================
        // VARI√ÅVEIS GLOBAIS
        // ==========================================
        let usuarioLogado = null;
        let tipoUsuario = null;
        let configuracao = {
            corredores: 5,
            prateleiras: 10,
            andares: 5,
            nichos: 3
        };
        let stream = null;
        let scannerAtivo = false;
        let tipoScanner = null; // 'entrada' ou 'saida'

        // ==========================================
        // INICIALIZA√á√ÉO
        // ==========================================
        window.onload = async function() {
            await carregarConfiguracao();
            console.log('Sistema iniciado');
        };

        // ==========================================
        // SISTEMA DE LOGIN
        // ==========================================
        async function fazerLogin() {
            const usuario = document.getElementById('loginUsuario').value.trim();
            const senha = document.getElementById('loginSenha').value.trim();

            if (!usuario || !senha) {
                alert('‚ùå Preencha usu√°rio e senha!');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('usuario', usuario)
                    .eq('senha', senha)
                    .eq('ativo', true)
                    .single();

                if (error || !data) {
                    alert('‚ùå Usu√°rio ou senha incorretos!');
                    return;
                }

                usuarioLogado = data.nome;
                tipoUsuario = data.tipo;
                mostrarSistema();

            } catch (err) {
                console.error('Erro no login:', err);
                alert('‚ùå Erro ao fazer login. Tente novamente.');
            }
        }

        function mostrarSistema() {
            document.getElementById('telaLogin').classList.add('hidden');
            document.getElementById('telaSistema').classList.remove('hidden');
            document.getElementById('nomeUsuario').textContent = usuarioLogado;
            
            const badge = document.getElementById('tipoUsuario');
            
            if (tipoUsuario === 'admin') {
                badge.textContent = 'ADMIN';
                badge.className = 'badge badge-admin';
                document.getElementById('dashboardAdmin').classList.remove('hidden');
                document.getElementById('dashboardOperador').classList.add('hidden');
                document.getElementById('tabRelatorio').classList.remove('hidden');
                document.getElementById('tabConfig').classList.remove('hidden');
            } else {
                badge.textContent = 'OPERADOR';
                badge.className = 'badge badge-operador';
                document.getElementById('dashboardOperador').classList.remove('hidden');
                document.getElementById('dashboardAdmin').classList.add('hidden');
                document.getElementById('tabRelatorio').classList.add('hidden');
                document.getElementById('tabConfig').classList.add('hidden');
            }

            atualizarDashboard();
            atualizarEstoque();
            if (tipoUsuario === 'admin') {
                atualizarRelatorio();
            }
        }

        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                fecharCamera();
                document.getElementById('telaLogin').classList.remove('hidden');
                document.getElementById('telaSistema').classList.add('hidden');
                document.getElementById('loginUsuario').value = '';
                document.getElementById('loginSenha').value = '';
                usuarioLogado = null;
                tipoUsuario = null;
            }
        }

        // ==========================================
        // SISTEMA DE ABAS
        // ==========================================
        function abrirAba(nomeAba) {
            if (tipoUsuario === 'operador' && (nomeAba === 'relatorio' || nomeAba === 'config')) {
                alert('‚ùå Voc√™ n√£o tem permiss√£o para acessar esta √°rea!');
                return;
            }

            fecharCamera();

            const abas = document.querySelectorAll('.tab-content');
            abas.forEach(aba => aba.classList.remove('active'));

            const botoes = document.querySelectorAll('.tab-btn');
            botoes.forEach(btn => btn.classList.remove('active'));

            document.getElementById('aba-' + nomeAba).classList.add('active');
            event.target.classList.add('active');

            if (nomeAba === 'estoque') {
                atualizarEstoque();
            } else if (nomeAba === 'relatorio' && tipoUsuario === 'admin') {
                atualizarRelatorio();
            }
        }

        // ==========================================
        // SCANNER DE C√ìDIGOS (BARRAS + QR CODE)
        // ==========================================
        function abrirCamera(tipo) {
            tipoScanner = tipo;
            const videoContainer = document.getElementById('video-container');
            const video = document.getElementById('video');
            
            videoContainer.classList.remove('hidden');
            scannerAtivo = true;

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(function(s) {
                stream = s;
                video.srcObject = stream;
                
                video.onloadedmetadata = function() {
                    video.play();
                    iniciarScanner();
                };
            })
            .catch(function(err) {
                alert('‚ùå Erro ao acessar c√¢mera: ' + err.message);
                videoContainer.classList.add('hidden');
                scannerAtivo = false;
            });
        }

        function iniciarScanner() {
            // Iniciar QuaggaJS para c√≥digos de barras
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#video'),
                    constraints: {
                        facingMode: "environment"
                    },
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Erro ao iniciar Quagga:', err);
                    // Continuar apenas com QR Code
                    iniciarScannerQR();
                    return;
                }
                Quagga.start();
                iniciarScannerQR();
            });

            Quagga.onDetected(function(result) {
                if (scannerAtivo && result.codeResult && result.codeResult.code) {
                    const codigo = result.codeResult.code;
                    processarCodigoLido(codigo);
                }
            });
        }

        function iniciarScannerQR() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            function verificarQRCode() {
                if (!scannerAtivo) return;

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);

                    if (code && code.data) {
                        processarCodigoLido(code.data);
                        return;
                    }
                }

                requestAnimationFrame(verificarQRCode);
            }

            verificarQRCode();
        }

        function processarCodigoLido(codigo) {
            if (!scannerAtivo) return;

            // Vibrar (se dispon√≠vel)
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }

            // Atualizar status
            document.getElementById('scanStatus').textContent = '‚úÖ C√≥digo detectado!';
            document.getElementById('scanStatus').style.background = 'rgba(40, 167, 69, 0.9)';

            // Preencher campo apropriado
            if (tipoScanner === 'entrada') {
                document.getElementById('codigoPacote').value = codigo;
            } else if (tipoScanner === 'saida') {
                document.getElementById('codigoPacoteSaida').value = codigo;
            }

            // Fechar c√¢mera ap√≥s 1 segundo
            setTimeout(() => {
                fecharCamera();
                
                // Se for sa√≠da, buscar automaticamente
                if (tipoScanner === 'saida') {
                    buscarPacote();
                }
            }, 1000);
        }

        function fecharCamera() {
            scannerAtivo = false;
            
            if (typeof Quagga !== 'undefined') {
                Quagga.stop();
            }
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            const video = document.getElementById('video');
            video.srcObject = null;
            
            document.getElementById('video-container').classList.add('hidden');
            document.getElementById('scanStatus').textContent = 'üì∑ Posicione o c√≥digo na √°rea verde';
            document.getElementById('scanStatus').style.background = 'rgba(0,0,0,0.8)';
        }

        // ==========================================
        // ENTRADA DE PACOTES
        // ==========================================
        async function registrarEntrada() {
            const codigo = document.getElementById('codigoPacote').value.trim();
            const fornecedor = document.getElementById('fornecedor').value.trim();
            const cliente = document.getElementById('cliente').value.trim();
            const telefone = document.getElementById('telefoneCliente').value.trim();
            const obs = document.getElementById('observacoes').value.trim();

            if (!codigo || !fornecedor || !cliente) {
                alert('‚ùå Preencha todos os campos obrigat√≥rios (*)');
                return;
            }

            try {
                const { data: existente } = await supabase
                    .from('pacotes')
                    .select('codigo')
                    .eq('codigo', codigo)
                    .eq('status', 'estoque')
                    .single();

                if (existente) {
                    alert('‚ùå Este c√≥digo j√° est√° registrado no estoque!');
                    return;
                }

                const localizacao = gerarLocalizacao();

                const { data: pacote, error: erroPacote } = await supabase
                    .from('pacotes')
                    .insert([{
                        codigo: codigo,
                        fornecedor: fornecedor,
                        cliente: cliente,
                        telefone: telefone,
                        observacoes: obs,
                        localizacao: localizacao,
                        status: 'estoque'
                    }])
                    .select()
                    .single();

                if (erroPacote) throw erroPacote;

                await supabase
                    .from('historico')
                    .insert([{
                        tipo: 'ENTRADA',
                        pacote_id: pacote.id,
                        codigo_pacote: codigo,
                        fornecedor: fornecedor,
                        cliente: cliente,
                        localizacao: localizacao,
                        usuario: usuarioLogado
                    }]);

                document.getElementById('codigoPacote').value = '';
                document.getElementById('fornecedor').value = '';
                document.getElementById('cliente').value = '';
                document.getElementById('telefoneCliente').value = '';
                document.getElementById('observacoes').value = '';

                atualizarDashboard();
                alert('‚úÖ Pacote registrado com sucesso!\nüìç Localiza√ß√£o: ' + localizacao);
                document.getElementById('localizacaoSugerida').textContent = gerarLocalizacao();

            } catch (err) {
                console.error('Erro ao registrar entrada:', err);
                alert('‚ùå Erro ao registrar pacote. Tente novamente.');
            }
        }

        function gerarLocalizacao() {
            const corredor = String.fromCharCode(65 + Math.floor(Math.random() * configuracao.corredores));
            const prateleira = String(Math.floor(Math.random() * configuracao.prateleiras) + 1).padStart(2, '0');
            const andar = Math.floor(Math.random() * configuracao.andares) + 1;
            const nicho = Math.floor(Math.random() * configuracao.nichos) + 1;
            
            return corredor + prateleira + andar + nicho;
        }

        setTimeout(() => {
            if (document.getElementById('localizacaoSugerida')) {
                document.getElementById('localizacaoSugerida').textContent = gerarLocalizacao();
            }
        }, 500);

        // ==========================================
        // SA√çDA DE PACOTES
        // ==========================================
        async function buscarPacote() {
            const codigo = document.getElementById('codigoPacoteSaida').value.trim();
            
            if (!codigo) {
                alert('‚ùå Digite o c√≥digo do pacote');
                return;
            }

            try {
                const { data: pacote, error } = await supabase
                    .from('pacotes')
                    .select('*')
                    .eq('codigo', codigo)
                    .eq('status', 'estoque')
                    .single();

                if (error || !pacote) {
                    alert('‚ùå Pacote n√£o encontrado no estoque!');
                    document.getElementById('infoPacote').classList.add('hidden');
                    document.getElementById('btnConfirmarSaida').classList.add('hidden');
                    return;
                }

                document.getElementById('infoCliente').textContent = pacote.cliente;
                document.getElementById('infoFornecedor').textContent = pacote.fornecedor;
                document.getElementById('infoLocalizacao').textContent = pacote.localizacao;
                document.getElementById('infoDataEntrada').textContent = new Date(pacote.data_entrada).toLocaleString('pt-BR');
                
                document.getElementById('infoPacote').classList.remove('hidden');
                document.getElementById('btnConfirmarSaida').classList.remove('hidden');

            } catch (err) {
                console.error('Erro ao buscar pacote:', err);
                alert('‚ùå Erro ao buscar pacote. Tente novamente.');
            }
        }

        async function registrarSaida() {
            const codigo = document.getElementById('codigoPacoteSaida').value.trim();

            try {
                const { data: pacote } = await supabase
                    .from('pacotes')
                    .select('*')
                    .eq('codigo', codigo)
                    .eq('status', 'estoque')
                    .single();

                if (!pacote) {
                    alert('‚ùå Erro ao processar sa√≠da');
                    return;
                }

                await supabase
                    .from('pacotes')
                    .update({ status: 'entregue', data_saida: new Date().toISOString() })
                    .eq('id', pacote.id);

                await supabase
                    .from('historico')
                    .insert([{
                        tipo: 'SA√çDA',
                        pacote_id: pacote.id,
                        codigo_pacote: pacote.codigo,
                        fornecedor: pacote.fornecedor,
                        cliente: pacote.cliente,
                        localizacao: pacote.localizacao,
                        usuario: usuarioLogado
                    }]);

                document.getElementById('codigoPacoteSaida').value = '';
                document.getElementById('infoPacote').classList.add('hidden');
                document.getElementById('btnConfirmarSaida').classList.add('hidden');

                atualizarDashboard();
                atualizarEstoque();

                if (tipoUsuario === 'operador') {
                    alert('‚úÖ Sa√≠da registrada com sucesso!');
                } else {
                    alert('‚úÖ Sa√≠da registrada com sucesso!\nüí∞ Lucro: R$ 1,50');
                }

            } catch (err) {
                console.error('Erro ao registrar sa√≠da:', err);
                alert('‚ùå Erro ao registrar sa√≠da. Tente novamente.');
            }
        }

        // ==========================================
        // ESTOQUE
        // ==========================================
        async function atualizarEstoque() {
            const tbody = document.getElementById('tabelaEstoque');
            const loading = document.getElementById('loadingEstoque');
            
            loading.classList.remove('hidden');

            try {
                const { data: pacotes, error } = await supabase
                    .from('pacotes')
                    .select('*')
                    .eq('status', 'estoque')
                    .order('data_entrada', { ascending: false });

                loading.classList.add('hidden');

                if (error) throw error;

                if (!pacotes || pacotes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">Nenhum pacote no estoque</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                pacotes.forEach(pacote => {
                    const dataEntrada = new Date(pacote.data_entrada);
                    const hoje = new Date();
                    const diasNoCD = Math.floor((hoje - dataEntrada) / (1000 * 60 * 60 * 24));

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${pacote.codigo}</strong></td>
                        <td>${pacote.cliente}</td>
                        <td>${pacote.fornecedor}</td>
                        <td><strong>${pacote.localizacao}</strong></td>
                        <td>${dataEntrada.toLocaleDateString('pt-BR')}</td>
                        <td>${diasNoCD} dia(s)</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                loading.classList.add('hidden');
                console.error('Erro ao carregar estoque:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Erro ao carregar estoque</td></tr>';
            }
        }

        function filtrarEstoque() {
            const busca = document.getElementById('buscaEstoque').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaEstoque tr');

            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                if (texto.includes(busca)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }

        // ==========================================
        // DASHBOARD E RELAT√ìRIOS
        // ==========================================
        async function atualizarDashboard() {
            try {
                const { count: totalEstoque } = await supabase
                    .from('pacotes')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'estoque');

                const { data: relatorio } = await supabase
                    .from('relatorio_lucros')
                    .select('*')
                    .single();

                if (tipoUsuario === 'admin') {
                    document.getElementById('totalPacotesAdmin').textContent = totalEstoque || 0;
                    document.getElementById('totalLucro').textContent = 'R$ ' + (relatorio?.lucro_total || 0).toFixed(2);
                    document.getElementById('totalEntradasAdmin').textContent = relatorio?.entradas_hoje || 0;
                    document.getElementById('totalSaidasAdmin').textContent = relatorio?.saidas_hoje || 0;
                } else {
                    document.getElementById('totalPacotes').textContent = totalEstoque || 0;
                    document.getElementById('totalEntradas').textContent = relatorio?.entradas_hoje || 0;
                    document.getElementById('totalSaidas').textContent = relatorio?.saidas_hoje || 0;
                }

            } catch (err) {
                console.error('Erro ao atualizar dashboard:', err);
            }
        }

        async function atualizarRelatorio() {
            if (tipoUsuario !== 'admin') return;

            const loading = document.getElementById('loadingHistorico');
            loading.classList.remove('hidden');

            try {
                const { data: relatorio } = await supabase
                    .from('relatorio_lucros')
                    .select('*')
                    .single();

                document.getElementById('relTotalProcessado').textContent = 
                    (relatorio?.total_entradas || 0) + (relatorio?.total_saidas || 0);
                document.getElementById('relLucroTotal').textContent = 'R$ ' + (relatorio?.lucro_total || 0).toFixed(2);

                const { data: historico, error } = await supabase
                    .from('historico')
                    .select('*')
                    .order('data_movimentacao', { ascending: false })
                    .limit(50);

                loading.classList.add('hidden');

                if (error) throw error;

                const tbody = document.getElementById('tabelaHistorico');

                if (!historico || historico.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Nenhuma movimenta√ß√£o registrada</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                historico.forEach(mov => {
                    const data = new Date(mov.data_movimentacao);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${data.toLocaleString('pt-BR')}</td>
                        <td><strong style="color: ${mov.tipo === 'ENTRADA' ? '#28a745' : '#dc3545'}">${mov.tipo}</strong></td>
                        <td>${mov.codigo_pacote}</td>
                        <td>${mov.cliente}</td>
                        <td>${mov.fornecedor}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                loading.classList.add('hidden');
                console.error('Erro ao carregar relat√≥rio:', err);
            }
        }

        // ==========================================
        // CONFIGURA√á√ïES
        // ==========================================
        async function carregarConfiguracao() {
            try {
                const { data, error } = await supabase
                    .from('configuracoes')
                    .select('*')
                    .single();

                if (data) {
                    configuracao = {
                        corredores: data.corredores,
                        prateleiras: data.prateleiras,
                        andares: data.andares,
                        nichos: data.nichos
                    };

                    document.getElementById('numCorredores').value = data.corredores;
                    document.getElementById('numPrateleiras').value = data.prateleiras;
                    document.getElementById('numAndares').value = data.andares;
                    document.getElementById('numNichos').value = data.nichos;
                }
            } catch (err) {
                console.error('Erro ao carregar configura√ß√£o:', err);
            }
        }

        async function salvarConfiguracao() {
            if (tipoUsuario !== 'admin') {
                alert('‚ùå Apenas administradores podem alterar configura√ß√µes');
                return;
            }

            try {
                configuracao.corredores = parseInt(document.getElementById('numCorredores').value);
                configuracao.prateleiras = parseInt(document.getElementById('numPrateleiras').value);
                configuracao.andares = parseInt(document.getElementById('numAndares').value);
                configuracao.nichos = parseInt(document.getElementById('numNichos').value);

                const { error } = await supabase
                    .from('configuracoes')
                    .update({
                        corredores: configuracao.corredores,
                        prateleiras: configuracao.prateleiras,
                        andares: configuracao.andares,
                        nichos: configuracao.nichos,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', (await supabase.from('configuracoes').select('id').single()).data.id);

                if (error) throw error;

                alert('‚úÖ Configura√ß√£o salva com sucesso!');

            } catch (err) {
                console.error('Erro ao salvar configura√ß√£o:', err);
                alert('‚ùå Erro ao salvar configura√ß√£o. Tente novamente.');
            }
        }
    </script>
</body>
</html>
